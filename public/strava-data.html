<!DOCTYPE html>
<html lang="sv">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Löparstatistik - IS Lärkan</title>
        
        <!-- Material Icons -->
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        
        <!-- CSS files -->
        <link rel="stylesheet" href="css/theme.css">
        <link rel="stylesheet" href="css/styles.css">
        <link rel="stylesheet" href="css/animations.css">
        
        <!-- Leaflet for map -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    </head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">
                <img src="/images/larkan-logo.png" alt="IS Lärkan Logo">
            </a>
            <div class="nav-links">
                <a href="/">Hem</a>
                <a href="/about">Om oss</a>
                <a href="/evenemang">Evenemang</a>
                <a href="/bli-medlem">Bli medlem</a>
                <a href="/strava-data" class="nav-highlight">Löparstatistik</a>
            </div>
        </div>
    </nav>

    <main>
        <section class="stats-hero">
            <div class="container">
                <h1>Löparstatistik</h1>
                <div id="monthly-stats" class="stats-grid">
                    <!-- Stats will be loaded here -->
                </div>
            </div>
        </section>

        <section class="map-section">
            <div class="container">
                <h2>Våra löprundor</h2>
                <div id="map"></div>
            </div>
        </section>
    </main>

    <script>
        // Fetch and display monthly activities
        fetch('/monthly-activities')
            .then(response => {
                if (response.status === 401) {
                    // If not authenticated, redirect to Strava auth
                    return response.json().then(data => {
                        window.location.href = data.authUrl;
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) return; // Skip if we're redirecting
                
                const statsGrid = document.getElementById('monthly-stats');
                const activities = data.aggregatedActivities;
                
                for (const [type, stats] of Object.entries(activities)) {
                    const distance = (stats.totalDistance / 1000).toFixed(1);
                    const hours = Math.floor(stats.totalTime / 3600);
                    const minutes = Math.floor((stats.totalTime % 3600) / 60);
                    
                    statsGrid.innerHTML += `
                        <div class="stat-card">
                            <h3>${type}</h3>
                            <p>Antal: ${stats.count}</p>
                            <p>Distans: ${distance} km</p>
                            <p>Tid: ${hours}h ${minutes}m</p>
                        </div>
                    `;
                }

                // Initialize map with heatmap data
                if (data.heatmapData && data.heatmapData.length > 0) {
                    const map = L.map('map').setView(data.heatmapData[0], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    
                    data.heatmapData.forEach(point => {
                        L.circle([point[0], point[1]], {
                            radius: 10,
                            color: 'red',
                            fillColor: 'red',
                            fillOpacity: 0.7
                        }).addTo(map);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Add error handling UI here
            });
    </script>
</body>
</html>